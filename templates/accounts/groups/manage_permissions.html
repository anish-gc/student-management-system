{% extends 'base.html' %}

{% load static %}
{% block title %}Manage Permissions - {{ group_obj.name }}{% endblock %}

{% block css %}
<style>
.permission-card {
    max-height: 600px;
    overflow-y: auto;
}
.permission-item {
    padding: 8px;
    margin-bottom: 5px;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    background-color: #f8f9fa;
    transition: all 0.2s ease;
}
.permission-item:hover {
    background-color: #e9ecef;
    transform: translateY(-1px);
}
.permission-item.assigned {
    background-color: #d4edda;
    border-color: #c3e6cb;
}
.app-header {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    padding: 10px 15px;
    margin-bottom: 10px;
    border-radius: 5px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
}
.model-header {
    background-color: #6c757d;
    color: white;
    padding: 5px 10px;
    margin: 10px 0 5px 0;
    border-radius: 3px;
    font-size: 0.9em;
    text-transform: capitalize;
}
.group-info-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}
.stats-card {
    border-left: 4px solid #007bff;
    padding: 15px;
    background-color: #f8f9fa;
    margin-bottom: 20px;
}
.transfer-buttons {
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 10px;
    padding: 20px;
}
.transfer-btn {
    min-width: 100px;
    padding: 10px 15px;
}
.bulk-actions {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 15px;
    border: 1px solid #dee2e6;
}
</style>
{% endblock %}

{% block content %}
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>Manage Permissions</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item">
                        <a href="{% url 'accounts:dashboard' %}">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'accounts:groups' %}">Group List</a>
                    </li>
                    <li class="breadcrumb-item active">Manage Permissions</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<section class="content">
    <div class="container-fluid">
        <!-- Group Info Header -->
        <div class="group-info-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h3 class="mb-1">
                        <i class="fas fa-users-cog mr-2"></i>
                        {{ group_obj.name }}
                    </h3>
                    <p class="mb-0">
                        <i class="fas fa-users mr-2"></i>{{ group_obj.user_set.count }} User(s)
                        <span class="ml-3">
                            <i class="fas fa-key mr-2"></i>{{ assigned_permissions|length }} Permission(s) Assigned
                        </span>
                    </p>
                </div>
                <div class="col-md-4 text-right">
                    <a href="{% url 'accounts:group-edit' group_obj.pk %}" class="btn btn-light">
                        <i class="fas fa-edit mr-1"></i> Edit Group
                    </a>
                </div>
            </div>
        </div>

        <!-- Statistics Card -->
        <div class="stats-card">
            <div class="row text-center">
                <div class="col-md-3">
                    <h4 class="text-primary">{{ assigned_permissions|length }}</h4>
                    <small class="text-muted">Assigned Permissions</small>
                </div>
                <div class="col-md-3">
                    <h4 class="text-info" id="available-count">0</h4>
                    <small class="text-muted">Available Permissions</small>
                </div>
                <div class="col-md-3">
                    <h4 class="text-success">{{ group_obj.user_set.count }}</h4>
                    <small class="text-muted">Users in Group</small>
                </div>
                <div class="col-md-3">
                    <h4 class="text-warning" id="total-permissions">0</h4>
                    <small class="text-muted">Total Permissions</small>
                </div>
            </div>
        </div>

        <form method="POST" id="permissions-form">
            {% csrf_token %}
            <div class="row">
                <!-- Assigned Permissions Column -->
                <div class="col-md-5">
                    <div class="card card-success">
                        <div class="card-header">
                            <h4 class="card-title">
                                <i class="fas fa-check-circle mr-2"></i>
                                Assigned Permissions
                                <span class="badge badge-light ml-2" id="assigned-count">{{ assigned_permissions|length }}</span>
                            </h4>
                            <div class="card-tools">
                                <button type="button" class="btn btn-sm btn-outline-light" id="remove-all-btn">
                                    <i class="fas fa-times"></i> Remove All
                                </button>
                            </div>
                        </div>
                        <div class="card-body permission-card" id="assigned-permissions">
                            {% if assigned_permissions %}
                                {% regroup group_obj.permissions.all by content_type.app_label as assigned_apps %}
                                {% for app_group in assigned_apps %}
                                <div class="app-header">{{ app_group.grouper|title }}</div>
                                {% regroup app_group.list by content_type.model as assigned_models %}
                                {% for model_group in assigned_models %}
                                    <div class="model-header">{{ model_group.grouper|title }}</div>
                                    {% for permission in model_group.list %}
                                    <div class="permission-item assigned" data-permission-id="{{ permission.id }}">
                                        <div class="form-check">
                                            <input class="form-check-input assigned-checkbox" type="checkbox" 
                                                   name="permissions" value="{{ permission.id }}" 
                                                   id="assigned_{{ permission.id }}" checked>
                                            <label class="form-check-label" for="assigned_{{ permission.id }}">
                                                <strong>{{ permission.name }}</strong>
                                                <br><small class="text-muted">{{ permission.codename }}</small>
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% endfor %}
                                {% endfor %}
                            {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-key fa-3x mb-3"></i>
                                    <p>No permissions assigned yet.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Transfer Buttons Column -->
                <div class="col-md-2">
                    <div class="transfer-buttons">
                        <button type="button" class="btn btn-primary transfer-btn" id="assign-selected-btn" title="Assign selected permissions">
                            <i class="fas fa-angle-left"></i><i class="fas fa-angle-left"></i>
                        </button>
                        <button type="button" class="btn btn-success transfer-btn" id="assign-all-btn" title="Assign all available permissions">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button type="button" class="btn btn-warning transfer-btn" id="remove-selected-btn" title="Remove selected permissions">
                            <i class="fas fa-angle-right"></i><i class="fas fa-angle-right"></i>
                        </button>
                        <button type="button" class="btn btn-danger transfer-btn" id="remove-all-btn-center" title="Remove all permissions">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Available Permissions Column -->
                <div class="col-md-5">
                    <div class="card card-info">
                        <div class="card-header">
                            <h4 class="card-title">
                                <i class="fas fa-list mr-2"></i>
                                Available Permissions
                                <span class="badge badge-light ml-2" id="available-badge">0</span>
                            </h4>
                            <div class="card-tools">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="select-all-available">
                                    <label class="form-check-label text-white" for="select-all-available">
                                        Select All
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="card-body permission-card" id="available-permissions">
                            <!-- Search box for available permissions -->
                            <div class="bulk-actions">
                                <input type="text" class="form-control" id="permission-search" 
                                       placeholder="Search available permissions...">
                            </div>
                            
                            {% regroup permissions_by_app.items by 0 as available_apps %}
                            {% for app_item in permissions_by_app.items %}
                                <div class="app-section" data-app="{{ app_item.0 }}">
                                    <div class="app-header">{{ app_item.0|title }}</div>
                                    {% for model_name, model_permissions in app_item.1.items %}
                                        <div class="model-section" data-model="{{ model_name }}">
                                            <div class="model-header">{{ model_name|title }}</div>
                                            {% for perm_data in model_permissions %}
                                                {% if not perm_data.is_assigned %}
                                                <div class="permission-item available" data-permission-id="{{ perm_data.permission.id }}">
                                                    <div class="form-check">
                                                        <input class="form-check-input available-checkbox" type="checkbox" 
                                                               value="{{ perm_data.permission.id }}" 
                                                               id="available_{{ perm_data.permission.id }}">
                                                        <label class="form-check-label" for="available_{{ perm_data.permission.id }}">
                                                            <strong>{{ perm_data.permission.name }}</strong>
                                                            <br><small class="text-muted">{{ perm_data.permission.codename }}</small>
                                                        </label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12 text-center">
                    <button type="submit" class="btn btn-success btn-lg" id="save-permissions-btn">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <i class="fas fa-save mr-2"></i>Save Permission Changes
                    </button>
                    <a href="{% url 'accounts:groups' %}" class="btn btn-secondary btn-lg ml-3">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Groups
                    </a>
                </div>
            </div>
        </form>
    </div>
</section>

{% endblock %}
{% block js_files %}

<script>
    $(document).ready(function() {
    // Update counters
    updateCounters();
    
    // Search functionality
    $('#permission-search').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('.available .permission-item').each(function() {
            const text = $(this).find('label').text().toLowerCase();
            $(this).toggle(text.includes(searchTerm));
        });
        
        // Hide/show app and model sections based on visible items
        $('.app-section').each(function() {
            const hasVisibleItems = $(this).find('.permission-item:visible').length > 0;
            $(this).toggle(hasVisibleItems);
        });
        
        // Hide/show model sections
        $('.model-section').each(function() {
            const hasVisibleItems = $(this).find('.permission-item:visible').length > 0;
            $(this).toggle(hasVisibleItems);
        });
        
        updateCounters();
    });

    // Select all available permissions
    $('#select-all-available').on('change', function() {
        const isChecked = $(this).is(':checked');
        $('.available-checkbox:visible').prop('checked', isChecked);
    });

    // Transfer buttons functionality
    $('#assign-selected-btn').on('click', function() {
        moveSelectedPermissions('.available-checkbox:checked', 'assigned');
    });

    $('#assign-all-btn').on('click', function() {
        moveAllPermissions('available', 'assigned');
    });

    $('#remove-selected-btn').on('click', function() {
        moveSelectedPermissions('.assigned-checkbox:checked', 'available');
    });

    $('#remove-all-btn, #remove-all-btn-center').on('click', function() {
        moveAllPermissions('assigned', 'available');
    });

    // Form submission
    $('#permissions-form').on('submit', function(e) {
        e.preventDefault();
        
        const button = $('#save-permissions-btn');
        const spinner = button.find('.spinner-border');
        const icon = button.find('.fa-save');
        
        // Show loading state
        button.prop('disabled', true);
        spinner.removeClass('d-none');
        icon.addClass('d-none');
        
        // Submit form via AJAX
        $.ajax({
            url: $(this).attr('action') || window.location.href,
            method: 'POST',
            data: $(this).serialize(),
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: response.message,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = response.redirect_url;
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: response.error || 'Failed to update permissions'
                    });
                }
            },
            error: function(xhr) {
                let errorMessage = 'An error occurred while updating permissions.';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.error || errorMessage;
                } catch (e) {
                    // Use default message
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: errorMessage
                });
            },
            complete: function() {
                // Reset loading state
                button.prop('disabled', false);
                spinner.addClass('d-none');
                icon.removeClass('d-none');
            }
        });
    });

    // Function to move selected permissions
    function moveSelectedPermissions(selector, targetType) {
        const selectedItems = $(selector);
        
        if (selectedItems.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'No Selection',
                text: 'Please select permissions to move.',
                timer: 2000,
                showConfirmButton: false
            });
            return;
        }

        selectedItems.each(function() {
            const checkbox = $(this);
            const permissionItem = checkbox.closest('.permission-item');
            const permissionId = permissionItem.data('permission-id');
            
            if (targetType === 'assigned') {
                moveToAssigned(permissionItem, permissionId);
            } else {
                moveToAvailable(permissionItem, permissionId);
            }
        });
        
        // Clear search and update counters
        $('#permission-search').val('');
        $('#select-all-available').prop('checked', false);
        updateCounters();
        reorganizePermissions();
    }

    // Function to move all permissions
    function moveAllPermissions(sourceType, targetType) {
        const confirmText = sourceType === 'assigned' ? 
            'Are you sure you want to remove all permissions from this group?' :
            'Are you sure you want to assign all available permissions to this group?';
            
        Swal.fire({
            title: 'Confirm Action',
            text: confirmText,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, proceed'
        }).then((result) => {
            if (result.isConfirmed) {
                const sourceSelector = sourceType === 'assigned' ? '.assigned-checkbox' : '.available-checkbox:visible';
                $(sourceSelector).each(function() {
                    const checkbox = $(this);
                    const permissionItem = checkbox.closest('.permission-item');
                    const permissionId = permissionItem.data('permission-id');
                    
                    if (targetType === 'assigned') {
                        moveToAssigned(permissionItem, permissionId);
                    } else {
                        moveToAvailable(permissionItem, permissionId);
                    }
                });
                
                $('#permission-search').val('');
                $('#select-all-available').prop('checked', false);
                updateCounters();
                reorganizePermissions();
            }
        });
    }

    // Function to move permission to assigned column
    function moveToAssigned(permissionItem, permissionId) {
        const checkbox = permissionItem.find('input[type="checkbox"]');
        
        // Update checkbox properties
        checkbox.removeClass('available-checkbox').addClass('assigned-checkbox');
        checkbox.prop('checked', true);
        checkbox.attr('name', 'permissions');
        checkbox.attr('id', 'assigned_' + permissionId);
        
        // Update label
        const label = permissionItem.find('label');
        label.attr('for', 'assigned_' + permissionId);
        
        // Update styling
        permissionItem.removeClass('available').addClass('assigned');
        
        // Move to assigned container
        $('#assigned-permissions').append(permissionItem);
    }

    // Function to move permission to available column
    function moveToAvailable(permissionItem, permissionId) {
        const checkbox = permissionItem.find('input[type="checkbox"]');
        
        // Update checkbox properties
        checkbox.removeClass('assigned-checkbox').addClass('available-checkbox');
        checkbox.prop('checked', false);
        checkbox.removeAttr('name');
        checkbox.attr('id', 'available_' + permissionId);
        
        // Update label
        const label = permissionItem.find('label');
        label.attr('for', 'available_' + permissionId);
        
        // Update styling
        permissionItem.removeClass('assigned').addClass('available');
        
        // Move to available container
        $('#available-permissions').append(permissionItem);
    }

    // Function to update counters
    function updateCounters() {
        const assignedCount = $('.assigned-checkbox').length;
        const availableCount = $('.available-checkbox:visible').length;
        const totalPermissions = assignedCount + $('.available-checkbox').length;
        
        $('#assigned-count').text(assignedCount);
        $('#available-count').text(availableCount);
        $('#available-badge').text(availableCount);
        $('#total-permissions').text(totalPermissions);
    }

    // Function to reorganize permissions by app and model
    function reorganizePermissions() {
        reorganizeContainer('#assigned-permissions');
        reorganizeContainer('#available-permissions');
    }

    // Helper function to reorganize a container
    function reorganizeContainer(containerSelector) {
        const container = $(containerSelector);
        const permissions = container.find('.permission-item').detach();
        
        // Group permissions by app and model
        const groupedPermissions = {};
        
        permissions.each(function() {
            const item = $(this);
            const label = item.find('label strong').text();
            const codename = item.find('label small').text();
            
            // Extract app and model from permission name or use codename
            // This is a simplified approach - you might need to adjust based on your permission naming convention
            let app = 'Other';
            let model = 'General';
            
            // Try to extract app and model from codename (e.g., "add_user" -> app: "auth", model: "user")
            if (codename.includes('_')) {
                const parts = codename.split('_');
                if (parts.length >= 2) {
                    model = parts.slice(1).join('_');
                }
            }
            
            if (!groupedPermissions[app]) {
                groupedPermissions[app] = {};
            }
            if (!groupedPermissions[app][model]) {
                groupedPermissions[app][model] = [];
            }
            
            groupedPermissions[app][model].push(item);
        });
        
        // Clear container and rebuild
        container.empty();
        
        // Add organized permissions back
        Object.keys(groupedPermissions).sort().forEach(app => {
            if (Object.keys(groupedPermissions[app]).length === 0) return;
            
            // Add app header
            container.append(`<div class="app-header">${app.charAt(0).toUpperCase() + app.slice(1)}</div>`);
            
            Object.keys(groupedPermissions[app]).sort().forEach(model => {
                if (groupedPermissions[app][model].length === 0) return;
                
                // Add model header
                container.append(`<div class="model-header">${model.charAt(0).toUpperCase() + model.slice(1)}</div>`);
                
                // Add permissions
                groupedPermissions[app][model].forEach(item => {
                    container.append(item);
                });
            });
        });
        
        // If container is empty, show message
        if (container.find('.permission-item').length === 0) {
            const emptyMessage = containerSelector === '#assigned-permissions' ? 
                '<div class="text-center text-muted py-4"><i class="fas fa-key fa-3x mb-3"></i><p>No permissions assigned yet.</p></div>' :
                '<div class="text-center text-muted py-4"><i class="fas fa-list fa-3x mb-3"></i><p>No available permissions.</p></div>';
            container.html(emptyMessage);
        }
    }

    // Handle individual checkbox changes
    $(document).on('change', '.available-checkbox', function() {
        updateSelectAllState();
    });

    // Update select all checkbox state
    function updateSelectAllState() {
        const totalVisible = $('.available-checkbox:visible').length;
        const checkedVisible = $('.available-checkbox:visible:checked').length;
        
        const selectAll = $('#select-all-available');
        
        if (checkedVisible === 0) {
            selectAll.prop('indeterminate', false);
            selectAll.prop('checked', false);
        } else if (checkedVisible === totalVisible) {
            selectAll.prop('indeterminate', false);
            selectAll.prop('checked', true);
        } else {
            selectAll.prop('indeterminate', true);
            selectAll.prop('checked', false);
        }
    }

    // Double-click to move individual permissions
    $(document).on('dblclick', '.permission-item.available', function() {
        const permissionId = $(this).data('permission-id');
        moveToAssigned($(this), permissionId);
        updateCounters();
        reorganizePermissions();
    });

    $(document).on('dblclick', '.permission-item.assigned', function() {
        const permissionId = $(this).data('permission-id');
        moveToAvailable($(this), permissionId);
        updateCounters();
        reorganizePermissions();
    });

    // Keyboard shortcuts
    $(document).on('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'a': // Ctrl+A: Select all available
                    if ($('#available-permissions:hover').length) {
                        e.preventDefault();
                        $('#select-all-available').trigger('click');
                    }
                    break;
                case 's': // Ctrl+S: Save
                    e.preventDefault();
                    $('#permissions-form').submit();
                    break;
            }
        }
    });

    // Add tooltips to transfer buttons
    $('[title]').tooltip();

    // Show/hide empty state messages
    function checkEmptyStates() {
        const assignedContainer = $('#assigned-permissions');
        const availableContainer = $('#available-permissions');
        
        if (assignedContainer.find('.permission-item').length === 0) {
            assignedContainer.html('<div class="text-center text-muted py-4"><i class="fas fa-key fa-3x mb-3"></i><p>No permissions assigned yet.</p></div>');
        }
        
        if (availableContainer.find('.permission-item:visible').length === 0) {
            const hasHiddenItems = availableContainer.find('.permission-item').length > 0;
            if (hasHiddenItems) {
                availableContainer.find('.text-center.text-muted').remove();
            } else {
                availableContainer.html('<div class="text-center text-muted py-4"><i class="fas fa-list fa-3x mb-3"></i><p>All permissions have been assigned.</p></div>');
            }
        }
    }

    // Enhanced move functions that handle reorganization
    function moveToAssignedEnhanced(permissionItem, permissionId) {
        moveToAssigned(permissionItem, permissionId);
        checkEmptyStates();
    }

    function moveToAvailableEnhanced(permissionItem, permissionId) {
        moveToAvailable(permissionItem, permissionId);
        checkEmptyStates();
    }

    // Drag and drop functionality (optional enhancement)
    $('.permission-item').draggable({
        helper: 'clone',
        revert: 'invalid',
        cursor: 'move',
        opacity: 0.7,
        start: function(event, ui) {
            ui.helper.addClass('dragging');
        }
    });

    $('.card-body.permission-card').droppable({
        accept: '.permission-item',
        hoverClass: 'drop-hover',
        drop: function(event, ui) {
            const droppedItem = ui.draggable;
            const targetContainer = $(this);
            const permissionId = droppedItem.data('permission-id');
            
            if (targetContainer.attr('id') === 'assigned-permissions' && droppedItem.hasClass('available')) {
                moveToAssignedEnhanced(droppedItem, permissionId);
                updateCounters();
                reorganizePermissions();
            } else if (targetContainer.attr('id') === 'available-permissions' && droppedItem.hasClass('assigned')) {
                moveToAvailableEnhanced(droppedItem, permissionId);
                updateCounters();
                reorganizePermissions();
            }
        }
    });

    // Add visual feedback for form changes
    let originalPermissions = new Set();
    $('.assigned-checkbox').each(function() {
        originalPermissions.add($(this).val());
    });

    function checkForChanges() {
        const currentPermissions = new Set();
        $('.assigned-checkbox').each(function() {
            currentPermissions.add($(this).val());
        });
        
        const hasChanges = !areSetsEqual(originalPermissions, currentPermissions);
        
        if (hasChanges) {
            $('#save-permissions-btn').removeClass('btn-success').addClass('btn-warning');
            $('#save-permissions-btn').find('i').removeClass('fa-save').addClass('fa-exclamation-triangle');
            $('.stats-card').addClass('border-warning');
        } else {
            $('#save-permissions-btn').removeClass('btn-warning').addClass('btn-success');
            $('#save-permissions-btn').find('i').removeClass('fa-exclamation-triangle').addClass('fa-save');
            $('.stats-card').removeClass('border-warning');
        }
    }

    function areSetsEqual(set1, set2) {
        if (set1.size !== set2.size) return false;
        for (let item of set1) {
            if (!set2.has(item)) return false;
        }
        return true;
    }

    // Monitor for changes
    $(document).on('change', '.assigned-checkbox, .available-checkbox', function() {
        setTimeout(checkForChanges, 100); // Small delay to ensure DOM updates
    });

    // Confirm navigation away if there are unsaved changes
    window.addEventListener('beforeunload', function(e) {
        const currentPermissions = new Set();
        $('.assigned-checkbox').each(function() {
            currentPermissions.add($(this).val());
        });
        
        if (!areSetsEqual(originalPermissions, currentPermissions)) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return 'You have unsaved changes. Are you sure you want to leave?';
        }
    });

    // Initial organization
    reorganizePermissions();
    checkEmptyStates();
    
    // Performance optimization: debounce search
    let searchTimeout;
    $('#permission-search').off('input').on('input', function() {
        clearTimeout(searchTimeout);
        const searchTerm = $(this).val().toLowerCase();
        
        searchTimeout = setTimeout(function() {
            $('.available .permission-item').each(function() {
                const text = $(this).find('label').text().toLowerCase();
                $(this).toggle(text.includes(searchTerm));
            });
            
            // Hide/show sections
            $('.app-section').each(function() {
                const hasVisibleItems = $(this).find('.permission-item:visible').length > 0;
                $(this).toggle(hasVisibleItems);
            });
            
            $('.model-section').each(function() {
                const hasVisibleItems = $(this).find('.permission-item:visible').length > 0;
                $(this).toggle(hasVisibleItems);
            });
            
            updateCounters();
            updateSelectAllState();
            checkEmptyStates();
        }, 300); // 300ms debounce
    });
});
</script>
<!--  -->{% endblock js_files %}
